<%- include("../../views/partials/admin/header") %>

<head>
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/sweetalert2@10/dist/sweetalert2.min.css" />
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.5/font/bootstrap-icons.css">
  <style>
    .form-label {
      font-weight: 500;
    }

    .table td,
    .table th {
      vertical-align: middle;
    } 

    a {
      text-decoration: none;
    }

    .btn-sm-custom {
      width: 100px;
      padding: 6px 12px;
      font-size: 0.875rem;
    }

    .btn-action {
      width: 80px;
    }
  </style>
</head>
<div class="container-fluid px-4">
<div class="content-header mb-4 mt-4">
  <h2 class="content-title card-title">Orders</h2>
</div>

<div class="row mb-4 justify-content-center">
  <div class="col-md-10">
    <div class="d-flex justify-content-between align-items-center">
      <!-- Search Form -->
      <form action="/admin/orders" method="get" id="searchForm" class="d-flex gap-2">
    <!-- search input -->
    <div class="position-relative flex-grow-1">
        <input 
            type="text" 
            name="search" 
            class="form-control rounded-pill pe-5"
            placeholder="Search orders" 
            value="<%= search || '' %>"
            style="min-width: 300px;">
       
    </div>

    <!-- sort -->
    <select name="sort" class="form-select rounded-pill">
        <option value="newest" <%= sort === "newest" ? "selected" : "" %>>Newest First</option>
        <option value="oldest" <%= sort === "oldest" ? "selected" : "" %>>Oldest First</option>
        <option value="amountHigh" <%= sort === "amountHigh" ? "selected" : "" %>>Amount High → Low</option>
        <option value="amountLow" <%= sort === "amountLow" ? "selected" : "" %>>Amount Low → High</option>
    </select>

    <!-- status filter -->
    <select name="status" class="form-select rounded-pill">
        <option value="">All Status</option>
        <option value="Placed" <%= statusFilter === "Placed" ? "selected" : "" %>>Placed</option>
        <option value="Cancelled" <%= statusFilter === "Cancelled" ? "selected" : "" %>>Cancelled</option>
        <option value="Delivered" <%= statusFilter === "Delivered" ? "selected" : "" %>>Delivered</option>
        <option value="Returned" <%= statusFilter === "Returned" ? "selected" : "" %>>Returned</option>
    </select>
<!-- date filter -->
    <select name="dateFilter" id="dateFilter" class="form-select rounded-pill">
        <option value="">All Dates</option>
        <option value="today" <%= dateFilter === "today" ? "selected" : "" %>>Today</option>
        <option value="week" <%= dateFilter === "week" ? "selected" : "" %>>This Week</option>
        <option value="year" <%= dateFilter === "year" ? "selected" : "" %>>This Year</option>
        <option value="custom" <%= dateFilter === "custom" ? "selected" : "" %>>Custom Range</option>
    </select>

     <!-- custom dates input -->
    <input type="hidden" name="startDate" id="hiddenStartDate" >
    <input type="hidden" name="endDate" id="hiddenEndDate" >

    <!-- Submit -->
    <button class="btn btn-dark btn-sm rounded-pill px-4" type="submit">Apply</button>

    <!-- Reset -->
    <a href="/admin/orders" class="btn btn-sm btn-outline-secondary rounded-pill ">Clear</a>
</form>

<!-- Download button -->
<div class="dropdown">
  <button class="btn btn-primary dropdown-toggle rounded-pill px-4" type="button" id="downloadDropdown" data-bs-toggle="dropdown" aria-expanded="false">
    Download Report
  </button>
  <ul class="dropdown-menu" aria-labelledby="downloadDropdown">
    <li>
      <a class="dropdown-item" href="#" id="downloadPdf">
        <i class="bi bi-file-earmark-pdf text-danger me-2"></i> PDF
      </a>
    </li>
    <li>
      <a class="dropdown-item" href="#" id="downloadExcel">
        <i class="bi bi-file-earmark-excel text-success me-2"></i> Excel
      </a>
    </li>
  </ul>
</div>

<!-- custom date modal -->
<div class="modal fade" id="customDateModal" tabindex="-1" aria-labelledby="customDateModalLabel" aria-hidden="true">
  <div class="modal-dialog modal-dialog-centered">
    <div class="modal-content rounded-3">
      <div class="modal-header">
        <h5 class="modal-title" id="customDateModalLabel">Select Custom Date Range</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body">
        <div class="mb-3">
          <label for="startDate" class="form-label">Start Date</label>
          <input type="date" id="startDate" class="form-control" >
        </div>
        <div>
          <label for="endDate" class="form-label">End Date</label>
          <input type="date" id="endDate" class="form-control" >
        </div>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
        <button type="button" id="applyCustomDate" class="btn btn-primary">Apply</button>
      </div>
    </div>
  </div>
</div>


    </div>
  </div>
</div>

<!-- orders Table -->
<div class="right mt-4">
  <table class="table table-hover shadow-sm">
    <thead class="table-light">
      <tr>
        <th>ID</th>
        <th>User</th>
        <th>Order Date</th>
        <th>Total Amount</th>
        <th>Products</th>
        <th>Total Amount/Product</th>
        <th>Status</th>
        <th>Return Request</th>
        <th>Delivery Date</th>
        <th>View Orders</th>
      </tr>
    </thead>
   <tbody>
  <% for (let i = 0; i < orderData.length; i++) { %>
    <% const order = orderData[i]; %>

    <% for (let j = 0; j < order.items.length; j++) { %>
      <% const item = order.items[j]; %>
      <tr>
        <% if (j === 0) { %>
          <!-- Common order info -->
          <td rowspan="<%= order.items.length %>"><%= order.orderId %></td>
          <td rowspan="<%= order.items.length %>"><%= order.userId.fullname %></td>
          <td rowspan="<%= order.items.length %>"><%= new Date(order.createdOn).toLocaleDateString("en-GB") %></td>
          <td rowspan="<%= order.items.length %>"><%= order.finalAmount %></td>
        <% } %>

        <!-- Product details -->
        <td>
          <div style="width: 4rem;">
            <img src="/uploads/re-product-image/<%= item.productId.productImage[0] %>" alt="<%= item.productId.productName %>">
          </div>
        </td>
        <td><%= item.totalPrice %></td>
        <td class="text-capitalize"><%= item.orderStatus %></td>

        <!-- Return Request -->
        <td class="text-capitalize">
          <% if (item.returnRequest && item.returnRequest.status) { %>
            <%= item.returnRequest.status %>
          <% } else { %>
            N/A
          <% } %>
        </td>

        <!-- Delivery Date -->
        <% if (item.deliveryDate) { %>
          <td><%= new Date(item.deliveryDate).toLocaleDateString("en-GB") %></td>
        <% } else { %>
          <td class="text-danger">No date added</td>
        <% } %>

        <% if (j === 0) { %>
          <td rowspan="<%= order.items.length %>" class="align-middle text-center">
            <a href="/admin/orders/view_order?id=<%= order._id %>" 
               class="btn btn-info text-white btn-action">View</a>
          </td>
        <% } %>
      </tr>
    <% } %>
  <% } %>
</tbody>
  </table>
</div>

<!-- Pagination -->
<div class="pagination d-flex justify-content-center mt-4">
  <% if (currentPage > 1) { %>
    <a href="/admin/orders?page=<%= currentPage - 1 %>" class="btn btn-outline-secondary mx-1">&laquo; Previous</a>
  <% } %>

  <% for (let i = 1; i <= totalPages; i++) { %>
    <% if (i === currentPage) { %>
      <span class="btn  mx-1"><%= i %></span>
    <% } else { %>
      <a href="/admin/orders?page=<%= i %>" class="btn btn-outline-secondary mx-1"><%= i %></a>
    <% } %>
  <% } %>

  <% if (currentPage < totalPages) { %>
    <a href="/admin/orders?page=<%= currentPage + 1 %>" class="btn btn-outline-secondary mx-1">Next &raquo;</a>
  <% } %>
</div>
</div>



<script src="https://cdn.jsdelivr.net/npm/sweetalert2@10/dist/sweetalert2.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.7.1/jquery.min.js"></script>
<%- include("../../views/partials/admin/footer") %>
<script>
  //reset page
    function resetPage(){
        document.getElementById("searchInput").value = ""
        document.getElementById('searchForm').submit()
    }

    //custome date
     const dateFilter = document.getElementById('dateFilter')
    const customDateModal = new bootstrap.Modal(document.getElementById('customDateModal'))
    const applyCustomDateBtn = document.getElementById('applyCustomDate')
    const hiddenStart = document.getElementById('hiddenStartDate')
    const hiddenEnd = document.getElementById('hiddenEndDate')
    const searchForm = document.getElementById('searchForm')

    dateFilter.addEventListener('change', () => {
        if (dateFilter.value === 'custom') {
            customDateModal.show()
        }
    })

    applyCustomDateBtn.addEventListener('click', () => {
        const start = document.getElementById('startDate').value
        const end = document.getElementById('endDate').value

        if (!start || !end) {
            alert('Please select both start and end dates.')
            return
        }

        hiddenStart.value = start
        hiddenEnd.value = end

        customDateModal.hide()
        searchForm.submit()
    })
// pass filters to url
     document.addEventListener('DOMContentLoaded', () => {
    const queryString = new URLSearchParams(window.location.search).toString();

    document.getElementById('downloadPdf').addEventListener('click', (e) => {
      e.preventDefault();
      window.location.href = `/admin/orders/report/pdf?${queryString}`;
    });

    document.getElementById('downloadExcel').addEventListener('click', (e) => {
      e.preventDefault();
      window.location.href = `/admin/orders/report/excel?${queryString}`;
    });
  });
</script>

