<%- include("../../views/partials/admin/header") %>


  <div class="container-fluid px-4">
    <!-- Page Heading -->
    <div class="row mb-4 mt-4 align-items-center">
      <div class="col">
        <h2 class="content-title fw-semibold mb-0">Customers</h2>
      </div>
    </div>

    <!-- Search Form -->
    <div class="row mb-4 justify-content-center">
      <div class="col-md-8">
        <form action="/admin/users" method="get" id="searchForm">
          <div class="d-flex align-items-center gap-2">

            <!-- Wrapper for input and clear button -->
            <div class="position-relative flex-grow-1">
              <input type="text" class="form-control rounded-pill pe-5" placeholder="Search customers..." name="search"
                id="searchInput" value="<%= search %>">
              <button type="button"
                class="btn position-absolute top-50 end-0 translate-middle-y me-3 p-0 border-0 bg-transparent"
                onclick="resetPage()" title="Clear">
                <i class="bi bi-x-lg"></i>
              </button>
            </div>

            <!-- Search button next to input -->
            <!-- <button class="btn btn-dark px-4 rounded-pill" type="submit">Search</button> -->

          </div>
        </form>
      </div>
    </div>


    <!-- Customer Table -->
    <div id="resultsContainer">
      <div class="table-responsive">
        <table class="table table-hover shadow-sm">
          <thead class="table-light">
            <tr>
              <th><b>Name</b></th>
              <th><b>Email</b></th>
              <th><b>Phone No</b></th>
              <th><b>Action</b></th>
            </tr>
          </thead>
          <tbody>
            <% for (let i=0; i < data.length; i++) { %>
              <tr>
                <td class="text-capitalize">
                  <%= data[i].fullname %>
                </td>
                <td>
                  <%= data[i].email %>
                </td>

                <td>
                  <% if(data[i].phone) { %>
                    <%= data[i].phone%>
                      <%} else{%>
                        <span class="text-muted">Not available</span>
                        <%}%>
                </td>
                <td>
                  <% if (!data[i].isBlocked) { %>
                    <button class="btn btn-sm btn-danger" onclick="confirmBlock('<%= data[i]._id %>')">Block</button>
                    <% } else { %>
                      <button class="btn btn-sm btn-success"
                        onclick="confirmUnblock('<%= data[i]._id %>')">Unblock</button>
                      <% } %>
                </td>
              </tr>
              <% } %>
          </tbody>
        </table>
      </div>
    </div>

    <!-- Pagination -->
    <div class="pagination d-flex justify-content-center mt-4">
      <% if (currentPage> 1) { %>
        <a href="/admin/users?page=<%= currentPage - 1 %>" class="btn btn-outline-secondary mx-1">&laquo; Previous</a>
        <% } %>

          <% for (let i=1; i <=totalPages; i++) { %>
            <% if (i===currentPage) { %>
              <span class="btn btn-outline-secondary mx-1">
                <%= i %>
              </span>
              <% } else { %>
                <a href="/admin/users?page=<%= i %>" class="btn btn-outline-secondary mx-1">
                  <%= i %>
                </a>
                <% } %>
                  <% } %>

                    <% if (currentPage < totalPages) { %>
                      <a href="/admin/users?page=<%= currentPage + 1 %>" class="btn btn-outline-secondary mx-1">Next
                        &raquo;</a>
                      <% } %>
    </div>
  </div>




  <%- include("../../views/partials/admin/footer") %>
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>

    <script>
      // function resetPage(){
      //     document.getElementById("searchInput").value = ""
      //     document.getElementById('searchForm').submit()
      // }


      function confirmBlock(userId) {
        Swal.fire({
          title: 'Block user?',
          icon: 'warning',
          text: 'Are you sure you want to block the user?',
          showCancelButton: true,
          cancelButtonText: 'Cancel',
          confirmButtonText: 'Block'
        }).then((result) => {
          if (result.isConfirmed) {
            fetch(`/admin/block_user?id=${userId}`, {
              method: 'get'
            })
              .then(() => location.reload())

          }

        })
      }

      function confirmUnblock(userId) {
        Swal.fire({
          title: 'Unblock user?',
          icon: 'warning',
          text: 'Are you sure you want to unblock the user?',
          showCancelButton: true,
          cancelButtonText: 'Cancel',
          confirmButtonText: 'Unblock'
        }).then((result) => {
          if (result.isConfirmed) {
            fetch(`/admin/unblock_user?id=${userId}`, {
              method: 'get'
            })
              .then(() => location.reload())
          }

        })
      }

      //search

      document.addEventListener('DOMContentLoaded', () => {
        const searchInput = document.getElementById('searchInput');
        const resultsContainer = document.getElementById('resultsContainer');
        const searchForm = document.getElementById('searchForm');

        
        if (searchForm) searchForm.addEventListener('submit', e => e.preventDefault());

        let controller = null;

        searchInput.addEventListener('input', async () => {
          const query = searchInput.value.trim();

          // cancel previous request
          if (controller) controller.abort();
          controller = new AbortController();

          try {
            const response = await fetch(`/admin/users?search=${encodeURIComponent(query)}`, {
              headers: { 'X-Requested-With': 'XMLHttpRequest' },
              signal: controller.signal
            });
            if (!response.ok) throw new Error('Network response was not ok');

            const html = await response.text();
            const tempDiv = document.createElement('div');
            tempDiv.innerHTML = html;

            // accept either id (old/new) or the table wrapper
            const newResults = tempDiv.querySelector('#resultsContainer')
              || tempDiv.querySelector('#resultContainer')
              || tempDiv.querySelector('.table-responsive')
              || tempDiv.querySelector('table');

            if (newResults && resultsContainer) {
              resultsContainer.innerHTML = newResults.innerHTML;
            } else {
              console.warn('Live search: could not find results container in response');
            }
          } catch (err) {
            if (err.name === 'AbortError') return; // expected when we abort previous fetch
            console.error('Live search error:', err);
          }
        });

        // intercept pagination links inside results so paging is ajax too
        resultsContainer?.addEventListener('click', async (e) => {
          const a = e.target.closest('a');
          if (!a) return;
          const href = a.getAttribute('href');
          if (href && href.startsWith('/admin/users')) {
            e.preventDefault();
            try {
              const resp = await fetch(href, { headers: { 'X-Requested-With': 'XMLHttpRequest' } });
              const html = await resp.text();
              const tmp = document.createElement('div');
              tmp.innerHTML = html;
              const nr = tmp.querySelector('#resultsContainer') || tmp.querySelector('#resultContainer') || tmp.querySelector('.table-responsive') || tmp.querySelector('table');
              if (nr) resultsContainer.innerHTML = nr.innerHTML;
            } catch (err) {
              console.error('Pagination load error:', err);
            }
          }
        });

        // global reset function used by your clear button
        window.resetPage = function () {
          const input = document.getElementById('searchInput');
          input.value = '';
          input.dispatchEvent(new Event('input', { bubbles: true }));
        };
      });
    </script>