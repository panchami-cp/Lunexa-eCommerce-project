<%- include("../../views/partials/admin/header") %>

<head>
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/sweetalert2@10/dist/sweetalert2.min.css" />
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.5/font/bootstrap-icons.css">
  <style>
    .form-label {
      font-weight: 500;
    }

    .table td,
    .table th {
      vertical-align: middle;
    } 

    a {
      text-decoration: none;
    }

    .btn-sm-custom {
      width: 100px;
      padding: 6px 12px;
      font-size: 0.875rem;
    }

    .btn-action {
      width: 80px;
    }
    tfoot.table-dark {
  position: sticky;
  bottom: 0;
  z-index: 10;
  background-color: #212529 !important;
  color: white;
}
  </style>
</head>
<div class="container-fluid px-4">
<div class="content-header mb-4 mt-4">
  <h2 class="content-title card-title">Sales Report</h2>
</div>

<div class="row mb-4 justify-content-center">
  <div class="col-md-10">
    <div class="d-flex justify-content-between align-items-center">
      <!-- Search Form -->
      <form action="/admin/sales_report" method="get" id="searchForm" class="d-flex gap-2">
    <!-- search input -->
    <div class="position-relative flex-grow-1">
        <input 
            type="text" 
            name="search" 
            class="form-control rounded-pill pe-5"
            placeholder="Search orders" 
            value="<%= search || '' %>"
            style="min-width: 300px;">
    </div>
    <!-- sort -->
    <select name="sort" class="form-select rounded-pill">
        <option value="newest" <%= sort === "newest" ? "selected" : "" %>>Newest First</option>
        <option value="oldest" <%= sort === "oldest" ? "selected" : "" %>>Oldest First</option>
        <option value="amountHigh" <%= sort === "amountHigh" ? "selected" : "" %>>Amount High → Low</option>
        <option value="amountLow" <%= sort === "amountLow" ? "selected" : "" %>>Amount Low → High</option>
    </select>
<!-- date filter -->
    <select name="dateFilter" id="dateFilter" class="form-select rounded-pill">
        <option value="">All Dates</option>
        <option value="today" <%= dateFilter === "today" ? "selected" : "" %>>Today</option>
        <option value="week" <%= dateFilter === "week" ? "selected" : "" %>>This Week</option>
        <option value="year" <%= dateFilter === "year" ? "selected" : "" %>>This Year</option>
        <option value="custom" <%= dateFilter === "custom" ? "selected" : "" %>>Custom Range</option>
    </select>

     <!-- custom dates input -->
    <input type="hidden" name="startDate" id="hiddenStartDate" >
    <input type="hidden" name="endDate" id="hiddenEndDate" >

    <!-- Submit -->
    <button class="btn btn-dark btn-sm rounded-pill px-4" type="submit">Apply</button>

    <!-- Reset -->
    <a href="/admin/sales_report" class="btn btn-sm btn-outline-secondary rounded-pill ">Clear</a>
</form>

<!-- Download button -->
<div class="dropdown">
  <button class="btn btn-primary dropdown-toggle rounded-pill px-4" type="button" id="downloadDropdown" data-bs-toggle="dropdown" aria-expanded="false">
    Download Report
  </button>
  <ul class="dropdown-menu" aria-labelledby="downloadDropdown">
    <li>
      <a class="dropdown-item" href="#" id="downloadPdf">
        <i class="bi bi-file-earmark-pdf text-danger me-2"></i> PDF
      </a>
    </li>
    <li>
      <a class="dropdown-item" href="#" id="downloadExcel">
        <i class="bi bi-file-earmark-excel text-success me-2"></i> Excel
      </a>
    </li>
  </ul>
</div>

<!-- custom date modal -->
<div class="modal fade" id="customDateModal" tabindex="-1" aria-labelledby="customDateModalLabel" aria-hidden="true">
  <div class="modal-dialog modal-dialog-centered">
    <div class="modal-content rounded-3">
      <div class="modal-header">
        <h5 class="modal-title" id="customDateModalLabel">Select Custom Date Range</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body">
        <div class="mb-3">
          <label for="startDate" class="form-label">Start Date</label>
          <input type="date" id="startDate" class="form-control" >
        </div>
        <div>
          <label for="endDate" class="form-label">End Date</label>
          <input type="date" id="endDate" class="form-control" >
        </div>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
        <button type="button" id="applyCustomDate" class="btn btn-primary">Apply</button>
      </div>
    </div>
  </div>
</div>


    </div>
  </div>
</div>

<!-- orders Table -->
<div class="right mt-4">
  <table class="table table-hover shadow-sm">
    <thead class="table-light">
      <tr>
        
        <th>ID</th>
        <th>Order Date</th>
        <th>Customer</th>
        <th>Product</th>
        <th>Payment Method</th>
        <th>Quantity</th>
        <th>MRP</th>
        <th>Discount</th>
        <th>Coupon</th>
        <th>Net Amount</th>
      </tr>
    </thead>
   <tbody>
  <%orderData.forEach((order)=>{%>
    <%order.items.forEach((item, index)=>{%>
      <tr>
          
          <td><%=order.orderId%></td>
          <td><%=new Date(order.createdOn).toLocaleDateString("en-GB")%></td>
          <td><%=order.userId.fullname%></td>
          <td><%=item.productId.productName%></td>
          <td><%=order.paymentMethod%></td>
          <td><%=item.quantity%></td>
          <td><%=item.regularPrice%></td>
          <td><%=item.discountPerUnit%></td>
          <td><%=item.couponSharePerUnit%></td>
          <td><%=item.netAmount%></td>
      </tr>
      <%})%>
  <%})%>
</tbody>
  <tfoot class="table-dark position-sticky bottom-0">
    <tr>
      <th colspan="5" class="text-end">Total: </th>
      <th><%= totalQuantity %></th>
      <th><%= totalMRP %></th>
      <th><%= totalDiscount %></th>
      <th><%= totalCoupon %></th>
      <th><%= totalNetAmount %></th>
    </tr>
  </tfoot>
  </table>
</div>

<!-- Pagination -->
<div class="pagination d-flex justify-content-center mt-4">
  <% if (currentPage > 1) { %>
    <a href="/admin/sales_report?page=<%= currentPage - 1 %>" class="btn btn-outline-secondary mx-1">&laquo; Previous</a>
  <% } %>

  <% for (let i = 1; i <= totalPages; i++) { %>
    <% if (i === currentPage) { %>
      <span class="btn  mx-1"><%= i %></span>
    <% } else { %>
      <a href="/admin/sales_report?page=<%= i %>" class="btn btn-outline-secondary mx-1"><%= i %></a>
    <% } %>
  <% } %>

  <% if (currentPage < totalPages) { %>
    <a href="/admin/sales_report?page=<%= currentPage + 1 %>" class="btn btn-outline-secondary mx-1">Next &raquo;</a>
  <% } %>
</div>
</div>



<script src="https://cdn.jsdelivr.net/npm/sweetalert2@10/dist/sweetalert2.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.7.1/jquery.min.js"></script>
<%- include("../../views/partials/admin/footer") %>
<script>
  //reset page
    function resetPage(){
        document.getElementById("searchInput").value = ""
        document.getElementById('searchForm').submit()
    }

    //custome date
     const dateFilter = document.getElementById('dateFilter')
    const customDateModal = new bootstrap.Modal(document.getElementById('customDateModal'))
    const applyCustomDateBtn = document.getElementById('applyCustomDate')
    const hiddenStart = document.getElementById('hiddenStartDate')
    const hiddenEnd = document.getElementById('hiddenEndDate')
    const searchForm = document.getElementById('searchForm')

    dateFilter.addEventListener('change', () => {
        if (dateFilter.value === 'custom') {
            customDateModal.show()
        }
    })

    applyCustomDateBtn.addEventListener('click', () => {
        const start = new Date(document.getElementById('startDate').value) 
        const end = new Date(document.getElementById('endDate').value) 

        if (!start || !end) {
          Swal.fire({
            icon: 'error',
            title: "Error",
            text: 'Please select both start and end dates.'
          })
            return
        }
         const today = new Date()
         today.setHours(0,0,0,0)
        if(start > today || end > today){
          Swal.fire({
            icon: 'error',
            title: "Error",
            text: 'Invalid dates. The date is in future'
          })
          return
        }
        if(end < start){
           Swal.fire({
            icon: 'error',
            title: "Error",
            text: 'Invalid end date'
          })
          return
        }
        hiddenStart.value = start
        hiddenEnd.value = end

        customDateModal.hide()
        searchForm.submit()
    })
// pass filters to url
     document.addEventListener('DOMContentLoaded', () => {
  const queryString = new URLSearchParams(window.location.search).toString();

  document.getElementById('downloadExcel').addEventListener('click', async (e) => {
    e.preventDefault();
//excel file download
    try {
      const res = await fetch(`/admin/sales_report/excel?${queryString}`);
      const contentType = res.headers.get('content-type') || '';
      if (contentType.includes('application/json')) {
        const data = await res.json();
        Swal.fire({
          icon: 'error',
          title: 'Error',
          text: data.message || 'No data available',
        });
        return;
      }

      const blob = await res.blob();
      const url = window.URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url;
      a.download = 'sales_report.xlsx';
      a.click();
      window.URL.revokeObjectURL(url);
    } catch (err) {
      console.error(err);
      Swal.fire({
        icon: 'error',
        title: 'Error',
        text: 'Failed to download Excel report.',
      });
    }
  });

  //pdf file download
  document.getElementById('downloadPdf').addEventListener('click', async (e) => {
    e.preventDefault();

    try {
      const res = await fetch(`/admin/sales_report/pdf?${queryString}`);

      const contentType = res.headers.get('content-type') || '';
      if (contentType.includes('application/json')) {
        const data = await res.json();
        Swal.fire({
          icon: 'error',
          title: 'Error',
          text: data.message || 'No data available',
        });
        return;
      }

      const blob = await res.blob();
      const url = window.URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url;
      a.download = 'sales_report.pdf';
      a.click();
      window.URL.revokeObjectURL(url);
    } catch (err) {
      console.error(err);
      Swal.fire({
        icon: 'error',
        title: 'Error',
        text: 'Failed to download PDF report.',
      });
    }
  });
});

</script>

