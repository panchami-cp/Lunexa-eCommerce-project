<%- include("../partials/user/header")%>
<head>
  <style>
    .modal {
  display: none;
  position: fixed;
  top: 0; left: 0;
  width: 100%; height: 100%;
  background: rgba(0,0,0,0.4);
  justify-content: center; align-items: center;
}

.modal-content {
  background: white;
  padding: 20px;
  border-radius: 10px;
  width: 300px;
}

.hidden { display: none; }

  </style>
</head>

<div class="container-fluid">

    <div class="shop-container">

      <main class="shop-products container mt-4">
        <div class="row">
          <h4 class="mb-5">My Wishlist </h4>
          <% for (let i = 0; i < products.length; i++) { %>
            <div class="col-md-3 mb-4 wishlist-item" data-product-id="<%= products[i]._id %>">
              <div class="product-item image-zoom-effect link-effect">
                <div class="image-holder position-relative">
                  <a href="/product_details?id=<%= products[i]._id %>">
                    <img src="/uploads/re-product-image/<%= products[i].productImage[0] %>" alt="<%= products[i].productName %>" class="product-image img-fluid">
                  </a>
                   <a href="/removeFromWishlist?id=<%=products[i]._id%>" 
                    class="btn-close position-absolute top-0 end-0 m-2" 
                    aria-label="Close"></a>
                  <div class="product-content">
                    <h5 class="element-title text-uppercase fs-5 mt-3">
                      <a href="index.html"><%= products[i].productName %></a>
                    </h5>
                    <p class="mb-0">Price: Rs.<%= products[i].salePrice %></p>
                    <a href="#" class="text-decoration-none add-to-cart-btn" data-id="<%=products[i]._id%>" >ADD TO CART</a>
                  </div>
                </div>
              </div>
            </div>
          <% } %>
        </div>
      <div class="pagination d-flex justify-content-center mt-4">
        <% if (currentPage > 1) { %>
          <a href="/wishlist?page=<%= currentPage - 1 %>"  class="btn btn-outline-secondary mx-1">&laquo; Previous</a>
        <% } %>
      
        <% for (let i = 1; i <= totalPages; i++) { %>
          <% if (i === currentPage) { %>
            <span class="btn  mx-1"><%= i %></span>
          <% } else { %>
            <a href="/wishlist?page=<%= i %>"  class="btn btn-outline-secondary mx-1"><%= i %></a>
          <% } %>
        <% } %>
      
        <% if (currentPage < totalPages) { %>
          <a href="/wishlist?page=<%= currentPage + 1 %>"  class="btn btn-outline-secondary mx-1">Next &raquo;</a>
        <% } %>
      </div>
    </main>

  </div>
</div>
<!-- size modal -->
<div id="sizeModal" class="modal hidden">
  <div class="modal-content">
    <a href="#" id="closeModal">&times;</a>
    <h5>Select a Size</h5>
    <div id="sizeOptions"></div>
    <button class="btn btn-dark" id="confirmAddToCart">Add to Cart</button>
  </div>
</div>

<script>
// open size modal
document.addEventListener("DOMContentLoaded", function() {
  const addToCartButtons = document.querySelectorAll(".add-to-cart-btn");
  const modal = document.getElementById("sizeModal");
  const sizeOptions = document.getElementById("sizeOptions");
  const closeModal = document.getElementById("closeModal");
  const confirmBtn = document.getElementById("confirmAddToCart");

  let selectedProductId = null;
  let selectedSize = null;

  addToCartButtons.forEach(btn => {
    btn.addEventListener("click", async function() {
      selectedProductId = this.dataset.id;
      modal.style.display = "flex"; 
      sizeOptions.innerHTML = "Loading sizes...";

      try {
        const res = await fetch(`/product-sizes?id=${selectedProductId}`);
        const data = await res.json();

        if (data.success && data.availableSizes.length > 0) {
          sizeOptions.innerHTML = data.availableSizes.map(size => `<button class="size-btn btn btn-outline-danger btn-sm" data-size="${size.size}">${size.size} (${size.quantity})</button>`)

          document.querySelectorAll(".size-btn").forEach(btn => {
            btn.addEventListener("click", function() {
              document.querySelectorAll(".size-btn").forEach(b => {
                b.classList.remove("selected")
                b.classList.add("btn-outline-danger")
                b.classList.remove("btn-danger")
              });
              this.classList.add("selected");
              this.classList.remove("btn-outline-danger")
              this.classList.add("btn-danger");
              selectedSize = this.dataset.size;
            });
          });
        } else {
          sizeOptions.innerHTML = "<p>No sizes available</p>";
        }

      } catch (err) {
        console.error(err);
        sizeOptions.innerHTML = "<p>Error loading sizes</p>";
      }
    });
  });

  closeModal.addEventListener("click", () => {
    modal.style.display = "none";
    selectedSize = null;
  });

  confirmBtn.addEventListener("click", async function() {
    if (!selectedSize) {
      showPopup("Please select a size", "error");
      return;
    }

    try {
      const res = await fetch(`/addToCart`, {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ productId: selectedProductId,selectedSize })
      });
      const data = await res.json();

      if (data.success) {
        showPopup(data.message, "success")
        modal.style.display = "none";
        const productCard = document.querySelector(`.wishlist-item[data-product-id="${selectedProductId}"]`);
  if (productCard) {
    productCard.remove();
  }
      } else {
        showPopup(data.message || "Failed to add to cart", "error");
      }
    } catch (err) {
      console.error(err);
      showPopup("Something went wrong", "error");
    }
  });
});
//popup
 function showPopup(message, type) {
    const popup = document.createElement('div')
    popup.textContent = message
    popup.style.position = 'fixed'
    popup.style.top = '20px'
    popup.style.left = '20px'
    popup.style.padding = '12px 20px'
    popup.style.borderRadius = '5px'
    popup.style.color = '#fff'
    popup.style.zIndex = '9999'
    popup.style.backgroundColor = type === 'error' ? '#a80810' : '#000'
    popup.style.boxShadow = '0 2px 6px rgba(0,0,0,0.2)'
    document.body.appendChild(popup)

    setTimeout(() => {
      popup.remove()
    }, 4000)
  }

</script>
 

<%- include("../partials/user/footer")%>

 </script>

    <script src="js/jquery.min.js"></script>
    <script src="js/plugins.js"></script>
    <script src="js/SmoothScroll.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha3/dist/js/bootstrap.bundle.min.js"
      integrity="sha384-ENjdO4Dr2bkBIFxQpeoTz1HIcje39Wm4jDKdf19U8gI4ddQ3GYNS7NTKfAdVQSZe"
      crossorigin="anonymous"></script>
    <script src="https://cdn.jsdelivr.net/npm/swiper@9/swiper-bundle.min.js"></script>
    <script src="js/script.min.js"></script>

    
    </body>

    </html>