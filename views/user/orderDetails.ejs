<%- include("../partials/user/header") %>

<head>
  <link rel="stylesheet" href="/css/user/orderDetails.css">
</head>

<div class="container my-4">
  <div class="order-details-box p-4 shadow-sm rounded bg-white">

    <!-- ===== TOP ROW: ORDER SUMMARY ===== -->
    <div class="row mb-4">
      <!-- Left side: Order details -->
      <div class="col-md-8">
        <h4>Order Details</h4>
        <p><strong>Order ID:</strong> <%= order.orderId %></p>
        <p><strong>Placed On:</strong> <%= new Date(order.createdOn).toLocaleDateString("en-GB") %></p>
        <p><strong>Payment Method: </strong><span class="text-capitalize badge bg-light text-dark"><%= order.paymentMethod %></span></p>
        <p><strong>Total Amount Paid:</strong> ₹<%= order.finalAmount %></p>
      </div>

      <!-- Right side: Delivery info -->
      <div class="col-md-4 text-md-end text-start">
        <p><strong>Delivery Date:</strong> 
          <%if(item.deliveryDate){%>
          <span><%= new Date(item.deliveryDate).toLocaleDateString("en-GB") %></span>
          <%}else{%>
            <span>Expect your delivery within one week</span><%}%></p>
        <% if (["Placed", "Processing", "Shipped", "Out for delivery", "Delivered"].includes(item.orderStatus)) { %>
          <a href="/download_invoice?id=<%= order._id %>" class="btn btn-outline-secondary btn-sm">Download Invoice</a>
        <% } %>
      </div>
    </div>
    <hr>
    <!-- ===== PRODUCT DETAILS ===== -->
    <div class="row align-items-center mb-4">
      <div class="col-md-3 text-center">
        <img src="/uploads/re-product-image/<%= item.productId.productImage[0] %>" 
             alt="<%= item.productId.productName %>" 
             class="img-fluid rounded border product-image">
      </div>
      <div class="col-md-9">
        <h5 class='text-uppercase'><%= item.productId.productName %></h5>
        <p><strong>Size:</strong> <%= item.size %></p>
      </div>
    </div>

    <hr>

    <!-- ===== PRICE & ADDRESS DETAILS ===== -->
    <div class="row mb-5">
      <!-- Left: Price details -->
      <div class="col-md-6">
        <h5 class="mb-3">Price Details</h5>
        <p><strong>MRP:</strong> ₹<%= item.regularPrice %></p>
        <p><strong>Discount:</strong> ₹<%=priceDetails.discount%></p>
        <p><strong>Coupon Share:</strong> ₹<%=priceDetails.couponSharePerItem%></p>
        <p><strong>Quantity:</strong> <%= item.quantity %></p>
        <p><strong>Final Payment (per item):</strong> ₹<%=priceDetails.finalAmountPerItem%></p>
      </div>

      <!-- Right: Address -->
      <div class="col-md-6">
        <h5 class=" mb-3">Delivery Address</h5>
        <p class="text-capitalize"><%= order.address.name %></p>
        <p class="text-capitalize"><%= order.address.building %>, <%= order.address.area %></p>
        <p class="text-capitalize"><%= order.address.city %> - <%= order.address.pincode %></p>
        <p class="text-capitalize"><%= order.address.state %></p>
        <p><strong>Phone:</strong> <%= order.address.phone %></p>
      </div>
    </div>

    <hr>

    <!-- ===== ORDER TRACKING ===== -->
    <div class="order-progress text-center mb-4">
      <% 
        const steps = ["Placed", "Shipped", "Out for Delivery", "Delivered"];
        const currentIndex = steps.indexOf(item.orderStatus);
      %>
      <div class="d-flex justify-content-center gap-3 flex-wrap">
        <% steps.forEach((step, index) => { %>
          <div class="progress-step-container <%= index <= currentIndex ? 'completed' : '' %> text-center">
            <div class="progress-step <%= index <= currentIndex ? 'completed' : '' %>"></div>
            <div class="step-label mt-1"><%= step %></div>
          </div>
        <% }) %>
      </div>
    </div>

    <!-- ===== ACTION BUTTONS ===== -->
    <div class="text-center mt-4">
      <% if (["Pending", "Placed", "Processing"].includes(item.orderStatus)) { %>
        <a href="/cancel_order?id=<%= item._id %>" class="btn btn-danger px-4">Cancel Order</a>
      <% } %>

      <% if (item.orderStatus === "Delivered" && (!item.returnRequest || !item.returnRequest.status)) { %>
        <a href="/return_order?id=<%= item._id %>" class="btn btn-danger px-4">Return</a>
      <% } %>
    </div>

  </div>
</div>

<!-- Footer -->
<%- include("../partials/user/footer") %>

<script src="js/jquery.min.js"></script>
<script src="js/plugins.js"></script>
<script src="js/SmoothScroll.js"></script>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha3/dist/js/bootstrap.bundle.min.js"
  integrity="sha384-ENjdO4Dr2bkBIFxQpeoTz1HIcje39Wm4jDKdf19U8gI4ddQ3GYNS7NTKfAdVQSZe"
  crossorigin="anonymous"></script>
<script src="https://cdn.jsdelivr.net/npm/swiper@9/swiper-bundle.min.js"></script>
<script src="js/script.min.js"></script>

</body>
</html>
