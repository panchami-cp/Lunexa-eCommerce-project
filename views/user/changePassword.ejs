<%- include("../partials/user/header")%>

  <head>
    <link rel="stylesheet" href="/css/user/signup.css">
  </head>

  <section class="auth-wrapper">
    <div class="auth-card login-card">
      <div class="auth-header text-uppercase">change password</div>

      <form action="/change_password" method="POST" class="auth-form" id="login_form">

        <div class="auth-field">
          <input type="password" placeholder="Current Password" class="auth-password" id="password" name="password">
          <i class='bx bx-hide toggle-visibility'></i>
          <div class="invalid-feedback" id="password_error"></div>
        </div>

        <div class="auth-field">
          <input type="password" placeholder="New Password" class="auth-password" id="newPassword" name="newPassword">
          <i class='bx bx-hide toggle-visibility'></i>
          <div class="invalid-feedback" id="newPassword_error"></div>
        </div>

        <div class="auth-field">
          <input type="password" placeholder="Confirm New Password" class="auth-password" id="confirmPassword"
            name="confirmPassword">
          <i class='bx bx-hide toggle-visibility'></i>
          <div class="invalid-feedback" id="confirmPassword_error"></div>
        </div>

        <% if (locals.message && locals.message.length> 0) { %>
          <div class="text-danger">
            <%=message%>
          </div>
          <% } %>

            <div class="auth-button-group">
              <button type="submit" class="auth-submit" style="background-color: black;">SAVE</button>
            </div>
      </form>
    </div>
  </section>

  <script>
    const password = document.getElementById('password');
    const newPassword = document.getElementById('newPassword');
    const passwordError = document.getElementById('password_error');
    const newPasswordError = document.getElementById('newPassword_error');
    const confirmPassword = document.getElementById('confirmPassword')
    const confirmPasswordError = document.getElementById('confirmPassword_error')

    function setInvalid(field, errorDiv, message) {
      field.classList.add('is-invalid');
      errorDiv.style.display = 'block';
      errorDiv.innerText = message;
    }

    function clearInvalid(field, errorDiv) {
      field.classList.remove('is-invalid');
      errorDiv.style.display = 'none';
      errorDiv.innerText = '';
    }

    function passwordValidation() {
      const passwordValue = password.value.trim();
      const newPasswordValue = newPassword.value.trim();
      const confirmPasswordValue = confirmPassword.value.trim()

      let isValid = true;

      // Reset errors
      clearInvalid(password, passwordError);
      clearInvalid(newPassword, newPasswordError);
      clearInvalid(confirmPassword, confirmPasswordError)

      // Check empty fields
      if (!passwordValue) {
        setInvalid(password, passwordError, 'Current password is required');
        isValid = false;
      }

      if (!newPasswordValue) {
        setInvalid(newPassword, newPasswordError, 'New password is required');
        isValid = false;
      }

      if (!confirmPasswordValue) {
        setInvalid(confirmPassword, confirmPasswordError, 'Confirm password is required');
        isValid = false;
      }

      // Check if new password is different from old password
      if (newPasswordValue === passwordValue) {
        setInvalid(newPassword, newPasswordError, 'New password must be different from current password')
        isValid = false;
      }

      // Check password strength
      const regex = /^(?=.*[a-z])(?=.*[A-Z])(?=.*\d)(?=.*[^A-Za-z0-9]).{8,}$/;
      if (newPasswordValue && !regex.test(newPasswordValue)) {
        setInvalid(newPassword, newPasswordError,
          'Password must be at least 8 characters long and include uppercase, lowercase, number, and special character'
        );
        isValid = false;
      }

      //check new password and confirm password matches
      if (newPasswordValue !== confirmPasswordValue) {
        setInvalid(confirmPassword, confirmPasswordError, "Password not matching")
        isValid = false
      }

      return isValid;
    }

    document.addEventListener("DOMContentLoaded", function () {
      document.getElementById("login_form").addEventListener("submit", function (event) {
        const isValid = passwordValidation();
        if (!isValid) {
          event.preventDefault();
        }
      });
    });
  </script>

  <script>

    function showPopup(message, type) {
      const popup = document.createElement('div')
      popup.textContent = message
      popup.style.position = 'fixed'
      popup.style.top = '20px'
      popup.style.left = '20px'
      popup.style.padding = '12px 20px'
      popup.style.borderRadius = '5px'
      popup.style.color = '#fff'
      popup.style.zIndex = '9999'
      popup.style.backgroundColor = '#000'
      popup.style.boxShadow = '0 2px 6px rgba(0,0,0,0.2)'
      document.body.appendChild(popup)

      setTimeout(() => {
        popup.remove()
      }, 2000)
    }
  </script>


  <!-- footer -->
  <%- include("../partials/user/footer")%>
    <script src="js/jquery.min.js"></script>
    <script src="js/plugins.js"></script>
    <script src="js/SmoothScroll.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha3/dist/js/bootstrap.bundle.min.js"
      integrity="sha384-ENjdO4Dr2bkBIFxQpeoTz1HIcje39Wm4jDKdf19U8gI4ddQ3GYNS7NTKfAdVQSZe"
      crossorigin="anonymous"></script>
    <script src="https://cdn.jsdelivr.net/npm/swiper@9/swiper-bundle.min.js"></script>
    <script src="js/script.min.js"></script>
    </body>

    </html>